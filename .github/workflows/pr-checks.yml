name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "Checking PR title: $PR_TITLE"
        
        # Check if PR title matches format: #NOISSUE - <title> or #60 - <title>
        if [[ ! "$PR_TITLE" =~ ^#(NOISSUE|[0-9]+)\ -\ .+ ]]; then
          echo "❌ Invalid PR title format!"
          echo ""
          echo "PR title must follow one of these formats:"
          echo "  • #NOISSUE - <description>"
          echo "  • #123 - <description>"
          echo ""
          echo "Examples:"
          echo "  ✓ #NOISSUE - fix linting errors"
          echo "  ✓ #60 - add user authentication"
          echo "  ✗ fix linting errors (missing issue reference)"
          echo "  ✗ #60 fix errors (missing dash separator)"
          echo ""
          echo "Current PR title: $PR_TITLE"
          exit 1
        fi
        
        echo "✓ PR title format is valid"
    
    - name: Check for large files
      run: |
        MAX_SIZE=5242880  # 5MB
        large_files=$(find . -type f -size +${MAX_SIZE}c ! -path "./.git/*" ! -path "./.github/*" ! -path "./htmlcov/*" ! -path "./.pytest_cache/*")
        if [ -n "$large_files" ]; then
          echo "Large files detected:"
          echo "$large_files"
          exit 1
        fi
    
    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        git merge --no-commit --no-ff origin/${{ github.base_ref }} || {
          echo "Merge conflicts detected!"
          exit 1
        }
        if [ -f .git/MERGE_HEAD ]; then
          git merge --abort
        fi
    
    - name: Validate commit messages
      run: |
        git log --pretty=format:"%s" origin/${{ github.base_ref }}..HEAD | while read commit_msg; do
          if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+"; then
            echo "Invalid commit message: $commit_msg"
            echo "Commit messages should follow: type(scope): description"
            exit 1
          fi
        done || echo "No commits to validate"

